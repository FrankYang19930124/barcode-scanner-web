<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手機條碼掃描機</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow: hidden; /* 防止內容溢出導致滾動條 */
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.8em;
        }
        /* 條碼掃描器的容器 */
        #interactive.viewport {
            width: 95%;
            max-width: 500px;
            aspect-ratio: 4/3; /* 固定寬高比 */
            position: relative;
            margin-bottom: 15px;
            overflow: hidden;
            background-color: #000; /* 相機啟動前的背景色 */
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* 我們自己創建的 video 元素和 QuaggaJS 繪圖 canvas */
        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 填充整個容器 */
            transform: scaleX(-1); /* 鏡像翻轉 */
            filter: brightness(1.1); /* 稍微增加亮度 */
            display: block; /* 確保影片是塊級元素 */
        }
        #interactive.viewport canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 讓滑鼠事件穿透到下面的 video */
        }


        /* 掃描結果顯示容器 */
        #result-container {
            width: 95%;
            max-width: 500px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-top: 10px;
            box-sizing: border-box;
        }
        #result {
            font-size: 1.8em;
            font-weight: bold;
            color: #007BFF;
            word-break: break-all;
            margin-top: 5px;
            min-height: 1.5em;
        }
        #hint {
            color: #666;
            margin-top: 10px;
            font-size: 1em;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 15px;
            text-align: center;
        }
        .status-message {
            color: #007BFF;
            font-weight: bold;
            margin-top: 15px;
            text-align: center;
        }
        /* 針對行動裝置的額外調整 */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.5em;
            }
            #result {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <h1>手機條碼掃描機</h1>

    <div id="interactive" class="viewport">
        <video id="videoElement" autoplay playsinline></video>
    </div>

    <div id="result-container">
        <p>掃描結果：</p>
        <div id="result">等待掃描...</div>
        <p id="hint">請將條碼對準畫面中央</p>
    </div>

    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
        // DOM 元素引用
        const resultDiv = document.getElementById('result');
        const hintDiv = document.getElementById('hint');
        const interactiveDiv = document.getElementById('interactive');
        const videoElement = document.getElementById('videoElement'); // 我們自己創建的 video 元素

        // 更新提示訊息的函式
        function updateStatus(message, isError = false) {
            resultDiv.innerHTML = isError ? `<span class="error-message">${message}</span>` : `<span class="status-message">${message}</span>`;
            hintDiv.textContent = "";
        }

        // 步驟 1: 取得相機串流並設定到 video 元素
        async function setupCamera() {
            try {
                updateStatus("正在請求相機權限...");
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment" // 優先使用後置鏡頭
                    }
                });
                videoElement.srcObject = stream;
                await videoElement.play(); // 確保影片開始播放

                updateStatus("相機已啟動，正在初始化掃描器...");
                startBarcodeScanner(stream); // 將串流傳給 QuaggaJS
                hintDiv.textContent = "請將條碼對準畫面中央";

            } catch (err) {
                console.error("無法存取相機:", err);
                let errorMessage = "錯誤：無法啟動相機。";
                if (window.location.protocol !== "https:") {
                    errorMessage += '<br>請確保網頁透過 **HTTPS (安全連線)** 開啟。';
                } else if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage += '<br>請檢查您的瀏覽器是否已授權此網站使用相機。';
                } else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') {
                    errorMessage += '<br>未找到可用的相機。';
                }
                updateStatus(errorMessage, true);
            }
        }

        // 步驟 2: 初始化 QuaggaJS
        function startBarcodeScanner(stream) {
            const QuaggaConfig = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    // *** 這裡修改為傳遞我們的 video 元素 ***
                    target: videoElement, // 將 QuaggaJS 的輸入目標設為我們的 video 元素
                    constraints: {
                        // 這裡不再需要 facingMode，因為已經在 getUserMedia 中設定了
                        // width 和 height 也由 video 元素處理
                    },
                    numOfWorkers: navigator.hardwareConcurrency || 2,
                },
                decoder: {
                    readers: [
                        "code_128_reader", "ean_reader", "ean_8_reader",
                        "code_39_reader", "upc_reader", "upc_e_reader"
                    ],
                    debug: { showCanvas: false }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                debug: {
                    drawBoundingBox: true,
                    drawScanline: true,
                    showCanvas: false // QuaggaJS 自己預設的偵錯畫布
                },
                frequency: 10,
                multiple: false
            };

            Quagga.init(QuaggaConfig, function(err) {
                if (err) {
                    console.error("Quagga 初始化失敗:", err);
                    updateStatus("掃描器初始化失敗。", true);
                    return;
                }
                console.log("Quagga 初始化成功，正在啟動掃描...");
                Quagga.start();

                // 移除之前移動 video/canvas 的代碼，因為現在 QuaggaJS 直接使用我們的 video
                // 並且它會自動在 #interactive.viewport 內創建一個 canvas.drawingBuffer
            });
        }

        // 頁面載入時啟動相機
        window.onload = setupCamera;

        // 監聽掃描結果
        Quagga.onDetected(function(data) {
            if (data && data.codeResult && data.codeResult.code) {
                const barcodeNumber = data.codeResult.code;
                resultDiv.textContent = barcodeNumber;
                hintDiv.textContent = "掃描成功！";
                console.log("掃描到的條碼:", barcodeNumber);

                // 如果您希望在掃描到結果後停止掃描，可以取消註解下面這行
                // Quagga.stop();
            }
        });

        // 監聽偵測過程中的即時結果 (用於繪製邊框和掃描線)
        Quagga.onProcessed(function(result) {
            const drawingCtx = Quagga.canvas.ctx.overlay;
            const drawingCanvas = Quagga.canvas.dom.overlay;
            drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.width), parseInt(drawingCanvas.height));

            if (result) {
                if (result.boxes) {
                    result.boxes.filter(function (box) {
                        return box !== result.box;
                    }).forEach(function (box) {
                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                    });
                }
                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                }
                if (result.codeResult && result.codeResult.code) {
                    Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                }
            }
        });

        // 確保在頁面關閉或重新整理時停止 QuaggaJS，釋放相機資源
        window.addEventListener('beforeunload', function() {
            Quagga.stop();
        });
    </script>
</body>
</html>
